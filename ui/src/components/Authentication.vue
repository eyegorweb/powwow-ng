<template>
  <span>
    <iframe v-if="refreshingToken" :src="refreshUrl" @load="onRefreshTokenPageLoaded" />
  </span>
</template>

<script>
import { mapActions, mapGetters, mapMutations } from 'vuex';
import { redirectTo } from '@/utils';
import { log } from '@/utils';
import { getBaseURL } from '@/utils.js';

export default {
  name: 'Authentication',
  created() {
    this.ensureUserIsAuthentified();
  },
  methods: {
    ...mapActions(['ensureTokenExists', 'setAuthToken', 'fetchUserInfos']),
    ...mapMutations(['stopRefreshingToken', 'startRefreshingToken', 'appIsReady']),

    ensureUserIsAuthentified() {
      if (this.$route.name === 'callback' || this.$route.name === 'refresh') {
        return;
      }
      if (!this.token) {
        this.startRefreshingToken();
      }
    },

    redirectToLogin() {
      // _ = route avant la redirection
      const sameUrl =
        location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');

      let urlToSave = window.location.href.replace(sameUrl, '');
      urlToSave = urlToSave.replace(process.env.VUE_APP_BASE_URL, '');

      redirectTo(
        `${this.authUrl}/oauth/authorize?response_type=token&client_id=${
          process.env.VUE_APP_CLIENT_ID
        }&redirect_uri=${window.location.origin}${
          process.env.VUE_APP_BASE_URL
        }/callback&prev=${urlToSave}`
      );
    },

    /*
      call the refresh url inslide the iframe, the server responds with content in the URL when refresh is possible
      and returns an error page with no content when refreshing token is no longuer possible
    */
    onRefreshTokenPageLoaded(frame) {
      try {
        if (frame.target.contentDocument) {
          try {
            this.setAuthToken(
              frame.target.contentDocument.location.href.split('=')[1].split('&')[0]
            );
            this.imReady();
          } catch (e) {
            log('Erreur token', e, frame.target.contentDocument.location);
            this.redirectToLogin();
          }

          this.stopRefreshingToken();
        } else {
          this.redirectToLogin();
        }
      } catch (e) {
        log('Erreur refresh ', e);
        this.stopRefreshingToken();
      }
    },

    async imReady() {
      await this.fetchUserInfos();
      this.appIsReady();
    },
  },
  computed: {
    ...mapGetters(['refreshingToken', 'token']),
    authUrl() {
      return getBaseURL();
    },
    refreshUrl() {
      return `${this.authUrl}/oauth/authorize?response_type=token&client_id=${
        process.env.VUE_APP_CLIENT_ID
      }&redirect_uri=${window.location.origin}/refresh.html`;
    },
  },
};
</script>

<style scoped>
iframe {
  width: 0;
  height: 0;
}
</style>
