<template>
  <div class="mt-4">
    <div class="row" v-if="!userIsPartner">
      <div class="col-md-9">
        <button @click.prevent="returnToSearch()" class="btn btn-link back-btn">
          <i class="ic-Arrow-Previous-Icon" />
          {{ $t('back') }}
        </button>
      </div>
    </div>
    <div class="row mb-5">
      <div class="col-md-9">
        <h4>
          <b>GetAdmin</b>
          - {{ partnerName }}
        </h4>
      </div>
    </div>

    <Summary
      v-if="partner && havePermission('party', 'read_account_detail')"
      :partner-id="this.$route.params.id"
      :partner-type="partner.partyType"
    />

    <div v-if="partner" class="mt-4 mb-4 bottom-space">
      <UiTabs :tabs="tabs" :selected-index="currentLinkIndex">
        <template slot-scope="{ tab, index, selectedIndex }">
          <UiTab
            v-if="tab"
            :is-selected="index === selectedIndex"
            class="tab-grow"
            :disable-menu="tab.disable"
          >
            <a class="tab-link" href="#" @click.prevent="() => (currentLinkIndex = index)">{{
              tab.title
            }}</a>
          </UiTab>
        </template>
        <div class="pt-4 pl-4" slot="users">
          <UsersTab :partnerid="this.$route.params.id" :partner="partner" />
        </div>
        <div class="pt-4 pl-4" slot="customize">
          <CustomizeTab :partnerid="this.$route.params.id" :partner="partner" />
        </div>
        <div class="pt-4 pl-4" slot="billingAccounts">
          <BillAccounts :partner="partner" />
        </div>
        <div class="pt-4 pl-4" slot="customerList">
          <PartnerCustomers :partner="partner" />
        </div>
        <div class="pt-4 pl-4" slot="accountDetail">
          <AccountDetail :partner="partner" />
        </div>
        <div class="pt-4 pl-4" slot="offersAndSim">
          <OffersTab :partner="partner" />
        </div>
      </UiTabs>
    </div>
  </div>
</template>

<script>
import Summary from './Summary';

import UiTabs from '@/components/ui/Tabs';
import UiTab from '@/components/ui/Tab';

import UsersTab from './UsersTab';
import CustomizeTab from './CustomizeTab';
import AccountDetail from './AccountDetail';
import OffersTab from './OffersTab';
import BillAccounts from './BillAccounts';
import PartnerCustomers from './PartnerCustomers';

import { fetchpartnerById } from '@/api/partners.js';

import { mapGetters } from 'vuex';

export default {
  components: {
    Summary,
    UiTabs,
    UiTab,

    BillAccounts,
    PartnerCustomers,
    UsersTab,
    CustomizeTab,
    AccountDetail,
    OffersTab,
  },

  async mounted() {
    // mvnoRanges
    this.partner = await fetchpartnerById(this.$route.params.id, {
      includeMailingLists: true,
      mvnoRanges: true,
    });
    this.prepareTabs();
  },

  data() {
    return {
      partner: undefined,
      currentLinkIndex: 0,
      tabs: [],
      show: undefined,
    };
  },

  methods: {
    returnToSearch() {
      this.$router.push({ name: 'getAdminPartners', params: { fromDetail: true } });
    },

    prepareTabs() {
      const tabs = [];
      const permissionsForUsersTab = [
        this.havePermission('party', 'read_administrator'),
        this.havePermission('user', 'read'),
      ];
      if (this.canShowTab(permissionsForUsersTab)) {
        tabs.push({
          label: 'users',
          title: this.$t('menu.users'),
        });
      }
      const permissionsForCustomizeTab = [
        this.havePermission('party', 'read_broadcast_list'),
        this.havePermission('party', 'read_delivery_address'),
        this.havePermission('party', 'read_custom_field'),
        this.havePermission('party', 'read_specific_field'),
      ];
      if (this.canShowTab(permissionsForUsersTab)) {
        tabs.push({
          label: 'customize',
          title: this.$t('getadmin.partners.customize'),
        });
      }

      if (this.partner && this.partner.partyType === 'MULTI_CUSTOMER') {
        tabs.push({
          label: 'customerList',
          title: this.$t('getadmin.partners.customerList'),
        });
      } else {
        if (this.havePermission('party', 'read_customer_account')) {
          tabs.push({
            label: 'billingAccounts',
            title: this.$t('filters.billingAccounts'),
          });
        }
      }

      const permissionsForOffersTab = [
        this.havePermission('party', 'read_available_catalog_offers2'),
        this.havePermission('party', 'read_available_sims2'),
        this.partner.partyType === 'CUSTOMER' &&
          this.havePermission('party', 'read_supervision_option'),
      ];
      if (this.canShowTab(permissionsForOffersTab)) {
        tabs.push({
          label: 'offersAndSim',
          title: this.$t('getadmin.partners.offersAndSim'),
        });
      }

      const permissionsForAccountDetailTab = [
        this.havePermission('party', 'read_account_detail') &&
          (this.havePermission('party', 'read_main_options') ||
            this.havePermission('party', 'read_secondary_options')),
        this.havePermission('party', 'read_account_detail') &&
          !(
            this.havePermission('party', 'read_main_options') ||
            this.havePermission('party', 'read_secondary_options')
          ),
        !this.havePermission('party', 'read_account_detail') &&
          (this.havePermission('party', 'read_main_options') ||
            this.havePermission('party', 'read_secondary_options')),
        this.partner && this.partner.partyType === 'MVNO',
      ];

      if (
        this.havePermission('party', 'read_account_detail') &&
        this.canShowTab(permissionsForAccountDetailTab)
      ) {
        tabs.push({
          label: 'accountDetail',
          title: this.$t('getadmin.partners.accountDetail'),
        });
      }

      this.tabs = tabs;
    },

    canShowTab(permissions) {
      return permissions.some(p => {
        return p;
      });
    },
  },

  computed: {
    ...mapGetters(['userIsPartner', 'havePermission']),
    partnerName() {
      return this.partner ? this.partner.name : '';
    },
  },
};
</script>

<style lang="scss" scoped>
.tab-grow {
  flex-grow: 1;
}
a.tab-link {
  text-transform: uppercase;
}
</style>
